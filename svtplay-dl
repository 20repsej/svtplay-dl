#!/usr/bin/env python
import re
import urllib2
import sys
import os
import subprocess
from optparse import OptionParser

def getdata(url):
    """ Get the page to parse it for streams """
    request = urllib2.Request(url)
    request.add_header = [('User-Agent', 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.9.0.3) Gecko/2008092417 Firefox/3.0.3')]
    response = urllib2.urlopen(request)
    data = response.read()
    response.close()
    return data

def calc_data(byte, total):
    """ Print some info about how much we have downloaded """
    percent = float(byte) / total
    percent = round(percent*100, 2)
    sys.stdout.write("Downloaded %d of %d bytes (%.2f%%)\r" % (byte, total, percent))
    if byte >= total:
        sys.stdout.write('\n')

def getrtmp(url, output):
    """ Get the stream from RTMP """
    other = ""
    if url[4:5] == "e":
        # For encrypted streams
        other = "-l 2"

    command = ["/usr/bin/rtmpdump", "-r", url, "-o", output, other]
    subprocess.call(command)

def gethttp(url, output):
    """ Get the stream from HTTP """
    response = urllib2.urlopen(url)
    total_size = response.info().getheader('Content-Length').strip()
    total_size = int(total_size)
    bytes_so_far = 0
    file_d = open(output,"wb")

    while 1:
        chunk = response.read(8192)
        bytes_so_far += len(chunk)
        
        if not chunk:
            break

        file_d.write(chunk)
        calc_data(bytes_so_far, total_size)

    file_d.close()

def main():
    """ Main program """
    usage = "usage: %prog [options] arg1"
    parser = OptionParser(usage=usage)
    parser.add_option("-o", "--output",
        metavar="OUTPUT", help="Outputs to the given filename.")
    (options, args) = parser.parse_args()
    if len(args) != 1:
        parser.error("incorrect number of arguments")
    output = options.output
    data = getdata(args[0])
    match = re.search('dynamicStreams=(.*)\&amp\;background', data)
    if match:
        new = match.group(1)
        tmp = new.split("|")
        match = re.search('url:(.*)\,', tmp[0])
    else:
        match = re.search('pathflv=(.*)\&amp\;background', data)
        if not match:
            print "Err: cant find stream"
            sys.exit(2)

    stream = match.group(1)
    if not output:
       output = os.path.basename(stream)
       print "Outfile: ", output

    if stream[0:4] == "rtmp":
        getrtmp(stream, output)
    else:
        gethttp(stream, output)

if __name__ == "__main__":
    main()
